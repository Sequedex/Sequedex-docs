Chapter 4: Phylogenetic and functional profiles

The ability of Sequedex to profile bacterial communities with metagenomic data leads naturally to the question of how a user's microbial community compares to previously sequenced microbial communities.  In this chapter, we lead the user through the process of computing phylogenetic profiles and comparing them to publically available datasets. In additional to phylogenetic information, the sequences obtained in a shotgun metagenomics dataset can be used to obtain functional profiles of genes in a microbial community, identify the presence of particular genes of interest, or even determine which of proteins are the most important determinants of classification within a set of microbial communities.  In this chapter, we we lead the user through the process of computing functional profiles.

Acquiring data:

Metagenomics data can be acquired several sources, including the Sequence Read Archive at NCBI, where the production phase of the human microbiome project can be found with the project number, SRP002163 and the study number SRP002163.  Individual data sets can be downloaded from their ftp site with a web browser (or using wget) at ftp://ftp-trace.ncbi.nlm.nih.gov/sra/sra-instant/reads/ByStudy/litesra/SRP/SRP002163/SRR059366.  Metadata about data sets, such as it is, can be obtained with the Run Browser at the Sequence Read Archive, http://www.ncbi.nlm.nih.gov/Traces/sra/?view=run_browser/.

Environmental metagenomics data sets can be found at NCBI with the taxonid 410658.  A wide variety of individual projects can be found, including samples from Pru Toh Daeng Peat Swamp, in Southern Thailand: SRR023820, which can be downloaded from ftp://ftp-trace.ncbi.nlm.nih.gov/sra/sra-instant/reads/ByStudy/sra/SRP/SRP001/SRP001114/SRR023820/SRR023820.sra.

In order to process data sets from the Sequence Read Archive, it will be necessary to extract fasta files from the .sra files obtained above.  This can be done with the fastq-dump utility from the SRA Toolkit, available for Linux, Mac, and Windows platforms at http://www.ncbi.nlm.nih.gov/Traces/sra/sra.cgi?view=software.  Generation of a fasta file from the HMB dataset above requires the command fastq-dump --fasta SRR059366.sra.

The Department of Energy's Joint Genome institute also maintains a repository of metagenomic sequence data at their integrated metagenomics (IM) site.

The CREO data from reference [1] can be downloaded in fasta format at http://img.jgi.doe.gov/cgi-bin/m/main.cgi?section=MetaDetail&downloadTaxonReadsFnaFile=1&taxon_oid=2029527002&noHeader=1, while additional metagenomics datasets are listed at http://img.jgi.doe.gov/cgi-bin/m/main.cgi?section=TaxonList&page=taxonListAlpha&domain=*Microbiome.

The Community Cyberinfrastructure for Advanced Microbial Ecology Research and Analysis site (CAMERA) also maintains a repository of metagenomics sequence data at https://portal.camera.calit2.net/gridsphere/gridsphere, where we were able to download data from the Global Ocean Survey (DB Rusch, et al. "The SorcererII Global Ocean Sampleing Expedition: Northwest Atlantic through Eastern Tropical Pacific" PLoS Biology, March 2007).

Using your own data requires only that it be put into the common fasta file format.  Since most sequencers supply data in fastq format (which supplies base-by-base quality scores in addition to to the amino acid sequence), you may need to convert the data from fastq to fasta.  Numerous utilities are available to do this, but a particularly simply way is available from teh Edwards lab at San Diego State University at http://edwards.sdsu.edu/labsite/index.php/robert/289-how-to-convert-fastq-to-fasta, with the nearly unreadable one-line perl script: cat file_in.fastq | perl -e '$i=0;while(<>){if(/^\@/&&$i==0){s/^\@/\>/;print;}elsif($i==1){print;$i=-3}$i++;}' > file_out.fasta.

*** running Sequedex
However you acquire your data, the fasta files to be analyzed by Sequedex in a given batch should all be placed in a single directory.  The analysis is run as described for your computing platform in the 'getting started' portion of this user's manual. For example, by typing "sequescan bact403.1.a *.fasta ./b403/".  This will create a directory b403 where output files corresponding to each input file will be placed.  For this section, we will concern ourselves with the phylogenetic profiles, that appear in the files 'infile.nodes', corresponding to each input fasta file.  For the next steps, we will show the results for two sets of fasta files: a set of 258 environmental metagenomes, and a set of 400 metagenomes from the human microbiome project.

*** comparison of phylogenetic and functional profiles
For those users wanting to look at output data as rapidly as possible, we supply two Excel spreadsheets with the collected results for the human microbiome data (hmbm.xlsx) and environmental metagenomes (env4.xlsx), and he or she can skip directly to the next section.

When comparing phylogenetic profiles of metagenomes, it is helpful to produce a matrix of phylogenetic profiles, with the 403 rows corresponding to the nodes on the bacterial phylogeny, and each sample assigned its own column, as well as a matrix of functional profiles, with the 982 rows corresponding to the SEED (http://www.theseed.org) functional categories.  This can be done in many ways, but a simple shell-script will do the job:

cd b403
for i in SRR059330 SRR059331 SRR059338 SRR059339; do
awk '{print $3}' < $i.fasta.nodes > $i.j;
awk '{print $3}' < $i.fasta.fun > $i.k;
done
paste SRR059330.j SRR059331.j SRR059338.j SRR059339.j > ../hmb.b403.ph
paste SRR059330.k SRR059331.k SRR059338.k SRR059339.k > ../hmb.b403.f

will combine the output files from four stool metagenomics data sets into a matrix of counts.

From these raw counts files, several types of profiles can easily be computed: phylogenetic rollups, normalized phylogenetic profiles, and normalized scalar products of the profiles.  Once again, these quantities can be computed in many ways, but the gfortran (http:/gcc.gnu.org/wiki/GFortran/) code pnorm.f90 and fnorm.f90 will suffice.  In particular, examination of the tree (bact403.phyloxml) with archyoptrix (http://www.phylosoft.org) reveals the following roll-up categories:

 ru(i,1)=sum(k(i,5:19))  !cyanobacteria
 ru(i,2)=sum(k(i,20:69))+sum(k(i,72:79)) !firmicutes
 ru(i,3)=sum(k(i,82:88)) !chloroflexi
 ru(i,4)=sum(k(i,90:92)) !synergistetes 
 ru(i,5)=sum(k(i,94:95)) ! Deinococcus
 ru(i,6)=sum(k(i,97:99)) ! thermotogae
 ru(i,7)=sum(k(i,100:149)) !actinobacteria 
 ru(i,8)=sum(k(i,151:248)) !b/g proteobacteria
 ru(i,9)=sum(k(i,255:256))  !acidobacteria
 ru(i,10)=sum(k(i,258:261))  !aquificae 
 ru(i,11)=sum(k(i,265:291)) !delta / epsilon proteobacteria
 ru(i,12)=sum(k(i,293:350)) !alpha proteobacteria
 ru(i,13)=sum(k(i,352:355)) !spirochaetes
 ru(i,14)=sum(k(i,358:361)) !planctomycetes
 ru(i,15)=sum(k(i,362:368)) !chlamydiae+verrucomicrobia
 ru(i,16)=sum(k(i,370:402)) !bacteroidetes
 ru(i,17)=k(i,2)+k(i,3)+k(i,4)+k(i,70)+k(i,71)+k(i,80)+k(i,81)+k(i,89)+k(i,93)+k(i,96)+k(i,150)+sum(k(i,249:254))+k(i,257)+k(i,292)+k(i,351)+sum(k(i,356:357))+k(i,369) !multiphyla
 ru(i,18)=k(i,1) !root

similarly, inspection of the output file SRR059330.fasta.fun provides the following rollup categories for function:

 ru(i,1)=sum(k(i,1:54))  !amino acids and derivatives
 ru(i,2)=sum(k(i,55:153)) !carbohydrates
 ru(i,3)=sum(k(i,154:162)) !cell division and cell cycle
 ru(i,4)=sum(k(i,163:213)) !cell wall and capsule 
 ru(i,5)=sum(k(i,214:357)) ! clustering-based
 ru(i,6)=sum(k(i,358:397)) !cofactors, vitamins, prosthetic groups, pigments 
 ru(i,7)=sum(k(i,398:431)) !dna metabolism 
 ru(i,8)=sum(k(i,432:445)) !dormancy and sporulation
 ru(i,9)=sum(k(i,446:464))  !fatty acids, lipids, and isoprenoids
 ru(i,10)=sum(k(i,465:488))  !Iron acquisition and metabolism 
 ru(i,11)=sum(k(i,489:534)) !membrane transport
 ru(i,12)=sum(k(i,535:564)) !metablism of aeromatic compounds
 ru(i,13)=sum(k(i,565:579)) !miscellaneous
 ru(i,14)=sum(k(i,580:587)) !motility and chemotaxis
 ru(i,15)=sum(k(i,588:597)) !nitrogen metabolism
 ru(i,16)=sum(k(i,598:615)) !nucleosides and nucleotides
 ru(i,17)=sum(k(i,616:637)) !phages, prophages, transposable elements
 ru(i,18)=sum(k(i,638:643)) !phosphorus metabolism
 ru(i,19)=sum(k(i,644:652)) !photosynthesis
 ru(i,20)=sum(k(i,653:656)) !potassium metabolism
 ru(i,21)=sum(k(i,657:722)) !protein metabolism
 ru(i,22)=sum(k(i,723:753)) !RNA metabolism
 ru(i,23)=sum(k(i,754:791)) !regulation and cell signaling
 ru(i,24)=sum(k(i,792:827)) !respiration
 ru(i,25)=sum(k(i,828:843)) !secondary metabolism
 ru(i,26)=sum(k(i,844:881)) !stress response
 ru(i,27)=sum(k(i,882:894)) !sulfur metabolism
 ru(i,28)=sum(k(i,895:962)) !virulence
 ru(i,29)=k(i,963) !no match

*** comparison of metagenomes

The set of output files can be viewed in Excel, and we supply two Excel spreadsheets with the collected results for the human microbiome data (hmbm.xlsx) and environmental metagenomes (env4.xlsx).  In the next section we will consider several quantitative analyses.

*** clustering with R

*** pairwise comparisons with R

*** niche determinants, gulf oil

*** tooth decay study

*** algal transcriptomics


